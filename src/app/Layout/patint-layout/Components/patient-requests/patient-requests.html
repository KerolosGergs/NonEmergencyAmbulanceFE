<div class="patient-requests">

  @if (loading) {
    <div class="alert alert-info">Loading requests...</div>
  }

  @if (error) {
    <div class="alert alert-danger">{{ error }}</div>
  }

  <!-- UPDATED: Tabs header -->
  <ul class="nav nav-tabs mb-3" role="tablist">
    @for (tab of tabs; track tab.key) {
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          [class.active]="activeStatus === tab.key"
          (click)="activeStatus = tab.key"
          type="button"
          role="tab">
          {{ tab.label }}
          <span class="badge bg-secondary ms-2">{{ countByStatus(tab.key) }}</span>
        </button>
      </li>
    }
  </ul>

  <!-- UPDATED: Tab content (filtered by activeStatus) -->
  <div class="tab-content animate__animated animate__fadeIn">
    @if (getRequestsByStatus(activeStatus).length === 0 && !loading) {
      <div class="text-center py-5">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">No {{ getStatusText(activeStatus) }} requests</h4>
        <p class="text-muted">There are currently no patient requests to display for this status.</p>
      </div>
    } @else {
      @for (request of getRequestsByStatus(activeStatus); track $index) {
        <div class="simple-request-card mb-3 animate__animated animate__fadeInUp">
          <div class="request-main">
            <div class="request-left">
              <div class="fs-4">
                <i [ngClass]="getStatusIconClasses(request.status)" aria-hidden="true"></i>
              </div>

              <div class="request-details">
                <h5 class="request-title">{{ request.emergencyType }}</h5>

                <div class="request-meta">
                  <span class="meta-item">
                    <i class="fas fa-calendar text-muted"></i>
                    {{ formatDate(request.requestDate) }}
                  </span>
                  <span class="meta-item">
                    <i class="fas fa-map-marker-alt text-muted"></i>
                    {{ request.pickupAddress }}
                  </span>
                  <span class="meta-item">
                    <i class="fas fa-flag-checkered text-muted"></i>
                    {{ request.dropOffAddress }}
                  </span>
                </div>

                @if (request.notes) {
                  <div class="request-notes">
                    <i class="fas fa-sticky-note text-muted"></i>
                    {{ request.notes }}
                  </div>
                }
              </div>
            </div>

            <div class="request-right">
              <div class="price-section">
                <div class="price-label">Total Price</div>
                <div class="price-amount">{{ request.price.toString() | currency:'EGP':true }}</div>
              </div>

              <div class="status-section">
                <span class="status-badge" [ngClass]="getStatusClass(request.status)">
                  {{ getStatusText(request.status) }}
                </span>
              </div>

              <!-- UPDATED: use enum instead of magic number 3 -->
              @if (request.status === RequestStatus.InProgress) {
                <div class="action-section">
                  <button class="btn btn-sm btn-outline-danger me-2"
                          (click)="cancelRequest(request.requestId)"
                          [disabled]="isProcessing">
                    <i class="fas fa-times"></i> Cancel
                  </button>
                  <button class="btn btn-sm btn-success"
                          (click)="confirmRequest(request.requestId)"
                          [disabled]="isProcessing">
                    <i class="fas fa-check"></i> Confirm
                  </button>
                </div>
              }
            </div>
          </div>

          @if (request?.driverId || request?.nurseId) {
            <div class="team-info">
              <div class="team-title">Assigned Team</div>

              <div class="team-members">
                <div class="team-member" [class.unassigned]="!request?.driverId">
                  <img
                    [src]="request?.driverId ? getImageUrl(request.driverImg) : 'assets/avatar-placeholder.png'"
                    class="member-avatar"
                    alt="Driver" />
                  <div class="member-details">
                    <div class="member-name">
                      @if (request?.driverId) { {{ request.driverName }} } @else { Unassigned }
                    </div>
                    <div class="member-role">Driver</div>
                  </div>
                </div>

                <div class="team-member" [class.unassigned]="!request?.nurseId">
                  <img
                    [src]="request?.nurseId ? getImageUrl(request.nurseImg) : 'assets/avatar-placeholder.png'"
                    class="member-avatar"
                    alt="Nurse" />
                  <div class="member-details">
                    <div class="member-name">
                      @if (request?.nurseId) { {{ request.nurseName }} } @else { Unassigned }
                    </div>
                    <div class="member-role">Nurse</div>
                  </div>
                </div>
              </div>
            </div>
          } @else {
            <div class="team-info empty">
              <div class="empty-icon"><i class="bi bi-people"></i></div>
              <div class="empty-text">No team assigned yet</div>
              <div class="empty-sub">Assign a driver or nurse to get started.</div>
            </div>
          }
        </div>
      }
    }
  </div>
</div>
