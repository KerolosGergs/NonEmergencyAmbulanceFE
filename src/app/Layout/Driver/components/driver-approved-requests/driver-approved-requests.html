<section class="nurse-dashboard container-fluid py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h5 class="fw-bold mb-0">Assigned Requests</h5>
  </div>

  <!-- UPDATED: Tabs header using @for -->
  <ul class="nav nav-tabs mb-3" role="tablist">
    @if (requests$ | async; as list) {
    @for (t of tabs; track t.key) {
    <li class="nav-item" role="presentation">
      <button class="nav-link" [class.active]="activeStatus === t.key" type="button" (click)="activeStatus = t.key"
        role="tab">
        {{ t.label }}
        <span class="badge bg-secondary ms-2">{{ countByStatus(list, t.key) }}</span>
      </button>
    </li>
    }
    }
  </ul>

  <div class="table-responsive bg-white border rounded-3 shadow-sm animate__animated animate__fadeIn">
    @if (requests$ | async; as list) {
    @if (filterByStatus(list, activeStatus).length === 0) {
    <div class="text-center py-5">
      <i class="bi bi-inbox fs-1 text-muted d-block mb-2"></i>
      <div class="text-muted">No {{ getActiveTabLabel() }} requests</div>
    </div>
    } @else {
    <table class="table align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Patient</th>
          <th>Pickup â†’ Drop-off</th>
          <th>Request Date</th>
          <th>Scheduled</th>
          <th>Type</th>
          <th>Status</th>
          <th class="text-end">Your Price (EGP)</th>
        </tr>
      </thead>
      <tbody>
        @for (r of filterByStatus(list, activeStatus); track $index) {
        <tr class="animate__animated animate__fadeInUp">
          <td>
            <div class="d-flex align-items-center gap-2">
              <img [src]="r.patientImageUrl" class="patient-img" alt="Patient">
              <div>
                <div class="fw-semibold">{{ r.patientName }}</div>
                <div class="text-muted small">{{ r.patientPhone }}</div>
              </div>
            </div>
          </td>

          <td>
            <div class="text-truncate" [title]="r.pickupAddress">
              <i class="bi bi-geo-alt me-1 text-primary"></i>{{ r.pickupAddress }}
            </div>
            <div class="text-truncate" [title]="r.dropOffAddress">
              <i class="bi bi-hospital me-1 text-success"></i>{{ r.dropOffAddress }}
            </div>
          </td>

          <td>
            <div class="small text-muted">{{ r.requestDate | date:'medium' }}</div>
          </td>
          <td>
            <div class="small">{{ r.scheduledDate | date:'medium' }}</div>
          </td>

          <td><span class="badge bg-soft border">{{ r.emergencyType }}</span></td>

          <td>
            <span class="badge" [ngClass]="getStatusClass(r.status)">
              {{ getStatusText(r.status) }}
            </span>
          </td>

          <td class="text-end fw-bold">
            {{ r.price.toString() | number:'1.0-0' }}
          </td>
        </tr>
        }
      </tbody>
    </table>
    }
    } @else {
    <!-- Optional: loading skeleton -->
    <div class="p-4 text-muted">Loading...</div>
    }
  </div>
</section>